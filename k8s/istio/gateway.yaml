# =============================================================================
# TRM Platform - Istio Service Mesh Configuration
# Production-grade service mesh with mTLS, traffic management, and observability
# =============================================================================

# -----------------------------------------------------------------------------
# 1. Istio Gateway - Main Entry Point
# -----------------------------------------------------------------------------
apiVersion: networking.istio.io/v1beta1
kind: Gateway
metadata:
  name: trm-gateway
  namespace: istio-system
  labels:
    app.kubernetes.io/name: trm
    app.kubernetes.io/component: gateway
spec:
  selector:
    istio: ingressgateway
  servers:
    - port:
        number: 80
        name: http
        protocol: HTTP
      hosts:
        - "trm.io"
        - "www.trm.io"
        - "api.trm.io"
        - "*.trm.io"
      tls:
        httpsRedirect: true
    - port:
        number: 443
        name: https
        protocol: HTTPS
      tls:
        mode: SIMPLE
        credentialName: trm-tls-secret
        minProtocolVersion: TLSV1_2
        cipherSuites:
          - ECDHE-RSA-AES256-GCM-SHA384
          - ECDHE-RSA-AES128-GCM-SHA256
      hosts:
        - "trm.io"
        - "www.trm.io"
        - "api.trm.io"
        - "*.trm.io"

---
# -----------------------------------------------------------------------------
# 2. Virtual Service - Main Application Routing
# -----------------------------------------------------------------------------
apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: trm-app
  namespace: trm
  labels:
    app.kubernetes.io/name: trm
    app.kubernetes.io/component: virtualservice
spec:
  hosts:
    - "trm.io"
    - "www.trm.io"
    - "api.trm.io"
  gateways:
    - istio-system/trm-gateway
  http:
    # Health check - no timeout
    - match:
        - uri:
            prefix: /health
        - uri:
            prefix: /api/health
      route:
        - destination:
            host: trm-app
            port:
              number: 3000
      timeout: 5s
      retries:
        attempts: 0

    # API routes
    - match:
        - uri:
            prefix: /api/
      route:
        - destination:
            host: trm-app
            port:
              number: 3000
          weight: 100
      timeout: 30s
      retries:
        attempts: 3
        perTryTimeout: 10s
        retryOn: gateway-error,connect-failure,refused-stream

    # Static assets - long cache
    - match:
        - uri:
            prefix: /assets/
      route:
        - destination:
            host: trm-app
            port:
              number: 3000
      timeout: 10s

    # Default route
    - route:
        - destination:
            host: trm-app
            port:
              number: 3000
      timeout: 30s
      retries:
        attempts: 3
        perTryTimeout: 10s

---
# -----------------------------------------------------------------------------
# 3. Destination Rule - Traffic Policies
# -----------------------------------------------------------------------------
apiVersion: networking.istio.io/v1beta1
kind: DestinationRule
metadata:
  name: trm-app
  namespace: trm
  labels:
    app.kubernetes.io/name: trm
    app.kubernetes.io/component: destinationrule
spec:
  host: trm-app
  trafficPolicy:
    connectionPool:
      tcp:
        maxConnections: 100
      http:
        http1MaxPendingRequests: 100
        http2MaxRequests: 1000
        maxRequestsPerConnection: 100
        maxRetries: 3
    loadBalancer:
      simple: LEAST_CONN
      localityLbSetting:
        enabled: true
        failover:
          - from: ap-southeast-1a
            to: ap-southeast-1b
          - from: ap-southeast-1b
            to: ap-southeast-1c
    outlierDetection:
      consecutive5xxErrors: 5
      interval: 30s
      baseEjectionTime: 30s
    portLevelSettings:
      - port:
          number: 3000
        connectionPool:
          http:
            h2UpgradePolicy: UPGRADE
  subsets:
    - name: stable
      labels:
        version: stable
    - name: canary
      labels:
        version: canary

---
# -----------------------------------------------------------------------------
# 4. Peer Authentication - mTLS
# -----------------------------------------------------------------------------
apiVersion: security.istio.io/v1beta1
kind: PeerAuthentication
metadata:
  name: default
  namespace: trm
  labels:
    app.kubernetes.io/name: trm
    app.kubernetes.io/component: peerauthentication
spec:
  mtls:
    mode: STRICT

---
# -----------------------------------------------------------------------------
# 5. Authorization Policy - Access Control
# -----------------------------------------------------------------------------
apiVersion: security.istio.io/v1beta1
kind: AuthorizationPolicy
metadata:
  name: trm-app
  namespace: trm
  labels:
    app.kubernetes.io/name: trm
    app.kubernetes.io/component: authorizationpolicy
spec:
  selector:
    matchLabels:
      app.kubernetes.io/name: trm
      app.kubernetes.io/component: app
  action: ALLOW
  rules:
    # Allow health checks from anywhere
    - to:
        - operation:
            paths: ["/health", "/api/health", "/health/live", "/health/ready"]
    
    # Allow API access from ingress gateway
    - from:
        - source:
            principals: ["cluster.local/ns/istio-system/sa/istio-ingressgateway"]
      to:
        - operation:
            methods: ["GET", "POST", "PUT", "PATCH", "DELETE"]
            paths: ["/api/*"]
    
    # Allow internal service communication
    - from:
        - source:
            namespaces: ["trm"]
      to:
        - operation:
            methods: ["GET", "POST"]

---
# -----------------------------------------------------------------------------
# 6. Request Authentication - JWT Validation
# -----------------------------------------------------------------------------
apiVersion: security.istio.io/v1beta1
kind: RequestAuthentication
metadata:
  name: trm-jwt
  namespace: trm
  labels:
    app.kubernetes.io/name: trm
    app.kubernetes.io/component: requestauthentication
spec:
  selector:
    matchLabels:
      app.kubernetes.io/name: trm
      app.kubernetes.io/component: app
  jwtRules:
    - issuer: "https://auth.trm.io"
      jwksUri: "https://auth.trm.io/.well-known/jwks.json"
      audiences:
        - "trm-api"
      forwardOriginalToken: true
      fromHeaders:
        - name: authorization
          prefix: "Bearer "

---
# -----------------------------------------------------------------------------
# 7. Rate Limiting with EnvoyFilter
# -----------------------------------------------------------------------------
apiVersion: networking.istio.io/v1alpha3
kind: EnvoyFilter
metadata:
  name: trm-rate-limit
  namespace: istio-system
spec:
  workloadSelector:
    labels:
      istio: ingressgateway
  configPatches:
    - applyTo: HTTP_FILTER
      match:
        context: GATEWAY
        listener:
          filterChain:
            filter:
              name: envoy.filters.network.http_connection_manager
      patch:
        operation: INSERT_BEFORE
        value:
          name: envoy.filters.http.local_ratelimit
          typed_config:
            "@type": type.googleapis.com/udpa.type.v1.TypedStruct
            type_url: type.googleapis.com/envoy.extensions.filters.http.local_ratelimit.v3.LocalRateLimit
            value:
              stat_prefix: http_local_rate_limiter
              token_bucket:
                max_tokens: 100
                tokens_per_fill: 10
                fill_interval: 1s
              filter_enabled:
                runtime_key: local_rate_limit_enabled
                default_value:
                  numerator: 100
                  denominator: HUNDRED
              filter_enforced:
                runtime_key: local_rate_limit_enforced
                default_value:
                  numerator: 100
                  denominator: HUNDRED
              response_headers_to_add:
                - append_action: OVERWRITE_IF_EXISTS_OR_ADD
                  header:
                    key: x-local-rate-limit
                    value: 'true'

---
# -----------------------------------------------------------------------------
# 8. Circuit Breaker Configuration
# -----------------------------------------------------------------------------
apiVersion: networking.istio.io/v1beta1
kind: DestinationRule
metadata:
  name: trm-circuit-breaker
  namespace: trm
spec:
  host: trm-app
  trafficPolicy:
    connectionPool:
      tcp:
        maxConnections: 100
      http:
        http1MaxPendingRequests: 100
        maxRequestsPerConnection: 10
    outlierDetection:
      consecutiveErrors: 7
      interval: 30s
      baseEjectionTime: 90s
      maxEjectionPercent: 50

---
# -----------------------------------------------------------------------------
# 9. Canary Deployment
# -----------------------------------------------------------------------------
apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: trm-canary
  namespace: trm
spec:
  hosts:
    - trm-app
  http:
    - match:
        - headers:
            canary:
              exact: "true"
      route:
        - destination:
            host: trm-app
            subset: canary
    - route:
        - destination:
            host: trm-app
            subset: stable
          weight: 90
        - destination:
            host: trm-app
            subset: canary
          weight: 10

---
# -----------------------------------------------------------------------------
# Installation Instructions:
# -----------------------------------------------------------------------------
# 1. Install Istio:
#    istioctl install --set profile=default -y
#
# 2. Enable sidecar injection for namespace:
#    kubectl label namespace trm istio-injection=enabled
#
# 3. Apply configurations:
#    kubectl apply -f k8s/istio/
#
# 4. Verify installation:
#    istioctl analyze
#    kubectl get pods -n istio-system
#
# 5. Access Kiali dashboard:
#    istioctl dashboard kiali
# -----------------------------------------------------------------------------
