# =============================================================================
# TRM Platform - Sealed Secrets Configuration
# Uses Bitnami Sealed Secrets for GitOps-friendly secret management
# https://github.com/bitnami-labs/sealed-secrets
# =============================================================================

# -----------------------------------------------------------------------------
# 1. Install Sealed Secrets Controller (run once per cluster)
# -----------------------------------------------------------------------------
# kubectl apply -f https://github.com/bitnami-labs/sealed-secrets/releases/download/v0.24.0/controller.yaml

# -----------------------------------------------------------------------------
# 2. Create Sealed Secrets for TRM Application
# -----------------------------------------------------------------------------

apiVersion: bitnami.com/v1alpha1
kind: SealedSecret
metadata:
  name: trm-app-secrets
  namespace: trm
  annotations:
    sealedsecrets.bitnami.com/cluster-wide: "false"
spec:
  encryptedData:
    # These are example encrypted values
    # To create real sealed secrets:
    # 1. Install kubeseal CLI: brew install kubeseal
    # 2. Create secret: kubectl create secret generic trm-app-secrets --from-literal=KEY=VALUE --dry-run=client -o yaml | kubeseal --controller-namespace=kube-system --controller-name=sealed-secrets --format yaml
    
    # JWT Secrets
    JWT_SECRET: AgByA...encrypted-value-here...==
    JWT_ACCESS_SECRET: AgByA...encrypted-value-here...==
    JWT_REFRESH_SECRET: AgByA...encrypted-value-here...==
    JWT_EMAIL_SECRET: AgByA...encrypted-value-here...==
    JWT_RESET_SECRET: AgByA...encrypted-value-here...==
    
    # Session & Encryption
    SESSION_SECRET: AgByA...encrypted-value-here...==
    ENCRYPTION_KEY: AgByA...encrypted-value-here...==
    ENCRYPTION_IV: AgByA...encrypted-value-here...==
    DB_ENCRYPTION_KEY: AgByA...encrypted-value-here...==
    
    # Database
    MONGODB_URI: AgByA...encrypted-value-here...==
    MONGODB_PASSWORD: AgByA...encrypted-value-here...==
    
    # Redis
    REDIS_URL: AgByA...encrypted-value-here...==
    REDIS_PASSWORD: AgByA...encrypted-value-here...==
    
    # API Keys
    API_KEY_SECRET: AgByA...encrypted-value-here...==
    WEBHOOK_SECRET: AgByA...encrypted-value-here...==
    INTERNAL_API_TOKEN: AgByA...encrypted-value-here...==
    
    # Payment Gateways
    STRIPE_API_KEY: AgByA...encrypted-value-here...==
    STRIPE_WEBHOOK_SECRET: AgByA...encrypted-value-here...==
    KBZPAY_API_KEY: AgByA...encrypted-value-here...==
    KBZPAY_SECRET: AgByA...encrypted-value-here...==
    WAVEPAY_API_KEY: AgByA...encrypted-value-here...==
    AYAPAY_API_KEY: AgByA...encrypted-value-here...==
    
    # Email
    SENDGRID_API_KEY: AgByA...encrypted-value-here...==
    SMTP_PASSWORD: AgByA...encrypted-value-here...==
    
    # OAuth
    GOOGLE_CLIENT_SECRET: AgByA...encrypted-value-here...==
    LINKEDIN_CLIENT_SECRET: AgByA...encrypted-value-here...==
    
    # AWS
    AWS_SECRET_ACCESS_KEY: AgByA...encrypted-value-here...==
    
    # Monitoring
    DATADOG_API_KEY: AgByA...encrypted-value-here...==
    PAGERDUTY_KEY: AgByA...encrypted-value-here...==
    
    # Messaging
    WHATSAPP_API_KEY: AgByA...encrypted-value-here...==
    VIBER_AUTH_TOKEN: AgByA...encrypted-value-here...==
    TELEGRAM_BOT_TOKEN: AgByA...encrypted-value-here...==
    TWILIO_AUTH_TOKEN: AgByA...encrypted-value-here...==
    
  template:
    metadata:
      name: trm-app-secrets
      namespace: trm
      labels:
        app.kubernetes.io/name: trm
        app.kubernetes.io/component: secrets
        app.kubernetes.io/part-of: trm-platform
    type: Opaque

---
# -----------------------------------------------------------------------------
# 3. MongoDB Credentials Sealed Secret
# -----------------------------------------------------------------------------
apiVersion: bitnami.com/v1alpha1
kind: SealedSecret
metadata:
  name: mongodb-credentials
  namespace: trm
spec:
  encryptedData:
    MONGODB_ROOT_PASSWORD: AgByA...encrypted-value-here...==
    MONGODB_USERNAME: AgByA...encrypted-value-here...==
    MONGODB_PASSWORD: AgByA...encrypted-value-here...==
  template:
    metadata:
      name: mongodb-credentials
      namespace: trm
      labels:
        app.kubernetes.io/name: mongodb
        app.kubernetes.io/component: database

---
# -----------------------------------------------------------------------------
# 4. TLS Certificate Sealed Secret (for custom domains)
# -----------------------------------------------------------------------------
apiVersion: bitnami.com/v1alpha1
kind: SealedSecret
metadata:
  name: trm-tls-certificate
  namespace: trm
spec:
  encryptedData:
    tls.crt: AgByA...encrypted-value-here...==
    tls.key: AgByA...encrypted-value-here...==
  template:
    metadata:
      name: trm-tls-certificate
      namespace: trm
      labels:
        app.kubernetes.io/name: trm
        app.kubernetes.io/component: tls
    type: kubernetes.io/tls

---
# -----------------------------------------------------------------------------
# 5. Docker Registry Credentials Sealed Secret
# -----------------------------------------------------------------------------
apiVersion: bitnami.com/v1alpha1
kind: SealedSecret
metadata:
  name: ghcr-registry-credentials
  namespace: trm
spec:
  encryptedData:
    .dockerconfigjson: AgByA...encrypted-value-here...==
  template:
    metadata:
      name: ghcr-registry-credentials
      namespace: trm
      labels:
        app.kubernetes.io/name: trm
        app.kubernetes.io/component: registry
    type: kubernetes.io/dockerconfigjson

---
# -----------------------------------------------------------------------------
# Instructions for Creating Sealed Secrets
# -----------------------------------------------------------------------------
# 
# 1. Install kubeseal CLI:
#    brew install kubeseal
# 
# 2. Get the public key from the controller:
#    kubeseal --fetch-cert --controller-namespace=kube-system > public-key.pem
#
# 3. Create a regular secret and seal it:
#    kubectl create secret generic my-secret \
#      --from-literal=password=mypassword \
#      --dry-run=client -o yaml | \
#      kubeseal --cert=public-key.pem --format yaml > my-sealed-secret.yaml
#
# 4. Apply the sealed secret:
#    kubectl apply -f my-sealed-secret.yaml
#
# 5. The controller will automatically decrypt and create the real secret
#
# -----------------------------------------------------------------------------
# Security Best Practices:
# -----------------------------------------------------------------------------
# 1. Never commit unencrypted secrets to Git
# 2. Use separate sealed secrets for different environments
# 3. Rotate secrets regularly (quarterly)
# 4. Use RBAC to restrict who can create/view sealed secrets
# 5. Backup the sealed-secrets controller's private key securely
# 6. Use cluster-wide secrets only when necessary (cross-namespace access)
# -----------------------------------------------------------------------------
